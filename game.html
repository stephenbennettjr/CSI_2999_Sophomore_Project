<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Guessing Game</title>
    <link rel="stylesheet" href="style2.css">
</head>
<body>
         <div class="top-header">
        <div class="header-left">
        <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24"><rect fill="none" height="24" width="24"/><g><path d="M7.5,21H2V9h5.5V21z M14.75,3h-5.5v18h5.5V3z M22,11h-5.5v10H22V11z"/></g></svg>
        </div>
        <div class="header-title">Music Guessing Game</div>
        <div class="header-right">
            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="white">
                <circle cx="12" cy="12" r="10" fill="none" stroke="white" stroke-width="2"/>
                <text x="12" y="16" text-anchor="middle" font-size="10" fill="white">i</text>
            </svg>
            <div class="info-popup">
                <p><strong>Music Guessing Game</strong></p>
                <p>Created by: Christian Kalaj, - , -, and </p>
                <p>Guess the song based on short audio segments from the current song playing! The earlier you guess the more points you earn!</p>
            </div>
        </div>
    </div>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <div class="game-container">
        <div class="game-view">
            <div class="game-function">
                <div class="left-div">
                    <div class="segment-selector">
                        <div class="track-element">
                            <div class="element-select active"></div>
                            <div class="element-label">Segment 1</div>
                        </div>
                        <div class="track-element">
                            <div class="element-select inactive"></div>
                            <div class="element-label">Segment 2</div>
                        </div>
                        <div class="track-element">
                            <div class="element-select inactive"></div>
                            <div class="element-label">Segment 3</div>
                        </div>
                        <div class="track-element">
                            <div class="element-select inactive"></div>
                            <div class="element-label">Segment 4</div>
                        </div>
                        <div class="track-element">
                            <div class="element-select inactive"></div>
                            <div class="element-label">Segment 5</div>
                        </div>
                    </div>
                    <div class="stats-container">
                        <ul class="stats-list">
                            <li class="stats-item">Attempts: <span id="attempts"></span></li>
                            <li class="stats-item">Score: <span id="score"></span></li>
                            <li class="stats-item">Songs: <span id="songs"></span></li>
                        </ul>
                    </div>
                </div>
                <div class="right-div">
                    <div class="player-container">
                        <div class="art-container">
                            <blur><img id="album-art" src="images/albumart2.jpg" alt="Album Art"></blur>
                            <div id="blur" class="blur"></div>
                        </div>
                        <div class="controls-container">
                            <div class="player-controls">
                              <div class="scrubber-container">
                                <span class="time-display">1:23</span>
                                <div class="progress-bar">
                                  <div class="progress-fill"></div>
                                  <div class="progress-handle"></div>
                                </div>
                                <span class="time-display">3:45</span>
                              </div>
                              <div class="play-controls">
                                <button class="control-button" aria-label="Previous">
                                    <svg width="16" height="16" viewBox="0 0 16 16">
                                      <path d="M13 2.5L5 7.119V3H3v10h2V8.881l8 4.619z" fill="currentColor"></path>
                                    </svg>
                                  </button>
                                <button class="play-pause-button play-button">▶</button>
                                <button class="play-pause-button pause-button" style="display: none;">⏸</button>
                                <button class="control-button" aria-label="Next">
                                    <svg width="16" height="16" viewBox="0 0 16 16">
                                      <path d="M11 3v4.119L3 2.5v11l8-4.619V13h2V3z" fill="currentColor"></path>
                                    </svg>
                                  </button>
                              </div>
                            </div>
                          </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="guess-container">
        <div class="guess-view">
            <input type="text" id="guess" class="guess-input" placeholder="Guess the song...">
        </div>
        <div class="select-year">
            <!--<select id="year-select">
                <option value="year" id ="year">Select Year</option>
            </select> -->
        </div>
        <button id="guess-button">Guess!</button>
    </div>
    <script src="game.js"></script>
    <script>
        let player; 
        window.onSpotifyWebPlaybackSDKReady = () => {
            function getAccessToken() {
                let hash = window.location.hash.substring(1);
                let params = new URLSearchParams(hash);
                let token = params.get('access_token');
                if (!token) {
                    token = new URLSearchParams(window.location.search).get('access_token');
                }
                return token;
            }

            const token = getAccessToken();
            console.log('OAuth attempt');
            player = new Spotify.Player({
                name: 'Guess the Game',
                getOAuthToken: cb => { cb(token); },
                volume: 0.5
            });
            player.connect();

            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);

                // Queue the track when the player is ready
                transferPlayback(device_id, token);
                playTrack(device_id, token); // Call playTrack when the player is ready
            });

            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
            });

            player.addListener('initialization_error', ({ message }) => {
                console.error(message);
            });

            player.addListener('authentication_error', ({ message }) => {
                console.error(message);
            });

            player.addListener('account_error', ({ message }) => {
                console.error(message);
            });
        };

        function queueTrack(trackUri, deviceId, token) {
            const url = `https://api.spotify.com/v1/me/player/queue?uri=${encodeURIComponent(trackUri)}&device_id=${deviceId}`;

            return fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                }
            })
            .then(response => {
                if (response.ok) {
                    console.log('Track successfully added to queue');
                    return Promise.resolve(); // Resolving the promise if the track is added successfully
                } else {
                    console.error('Failed to add track to queue:', response.status, response.statusText);
                    return Promise.reject('Failed to add track'); // Rejecting the promise on failure
                }
            })
            .catch(error => {
                console.error('Error adding track to queue:', error);
                return Promise.reject(error); // Ensuring the error gets propagated
            });
        }

        function transferPlayback(deviceId, token) {
            fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    device_ids: [deviceId]  // The device ID to transfer playback to
                })
            })
            .then(response => {
                if (response.ok) {
                    console.log('Playback successfully transferred to device:', deviceId);
                } else {
                    console.error('Failed to transfer playback:', response.status, response.statusText);
                }
            })
            .catch(error => {
                console.error('Error transferring playback:', error);
            });
        }

        function playTrack(device_id, token) {
            queueTrack('spotify:track:4xeFxp27NAtRoUrNcgVD9k', device_id, token)
                .then(() => {
                    console.log('Track queued successfully');
                    // Immediately pause the track after it's queued
                    return player.pause();
                })
                .then(() => {
                    console.log('Track is paused after loading');
                })
                .catch((error) => {
                    console.error('Error during track queue or playback:', error);
                });
        }


        document.addEventListener('DOMContentLoaded', function() {
            const playButton = document.querySelector('.play-button');
            const pauseButton = document.querySelector('.pause-button');

            playButton.addEventListener('click', function() {
                playButton.style.display = 'none';
                pauseButton.style.display = 'block';
                
                player.togglePlay().then(() => {
                    console.log('Track is playing');
                }).catch(err => {
                    console.error('Error playing track:', err);
                });
            });

            pauseButton.addEventListener('click', function() {
                pauseButton.style.display = 'none';
                playButton.style.display = 'block';
                
                player.pause().then(() => {
                    console.log('Track is paused');
                }).catch(err => {
                    console.error('Error pausing track:', err);
                });
            });
        });
    </script>
    <div id="song-title" style="margin: 1rem; font-size: 1.2rem; color: #fff;"></div>
</body>
</html>
